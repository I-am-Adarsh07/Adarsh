<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout & Payment | All In One Store</title>
    <link rel="stylesheet" href="styles.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* [NOTE]: For a complete solution, please ensure these styles are in your styles.css */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .main-header { background-color: white; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3); }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; }
        .checkout-main { padding-top: 40px; }
        .checkout-layout { display: flex; gap: 40px; margin-top: 20px; flex-wrap: wrap; }
        .checkout-form-section { flex: 2; min-width: 350px; }
        .checkout-summary { flex: 1; min-width: 300px; background-color: #f7f7f7; padding: 25px; border-radius: 10px; height: fit-content; }
        
        .checkout-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .save-address-btn, .checkout-btn { width: 100%; padding: 15px; background-color: #0048E3; color: white; border: none; border-radius: 6px; font-size: 1.1em; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        .save-address-btn:hover, .checkout-btn:hover:enabled { background-color: #0036a8; }

        /* Payment Options */
        .payment-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .payment-option-card { display: flex; align-items: flex-start; gap: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; transition: border-color 0.2s; background-color: white; }
        .payment-option-card:hover { border-color: #0048E3; }
        .payment-option-card input[type="radio"] { margin-top: 4px; }
        .payment-option-card span { font-weight: 600; color: #1c1c1c; }
        .payment-option-card p { font-size: 0.9em; color: #555; margin-top: 2px; }

        /* Summary Details */
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #ddd; }
        .summary-item img { margin-right: 15px; }
        .summary-item p { flex-grow: 1; font-size: 0.95em; }
        .summary-details p { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1em; }
        .summary-total { border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px; font-size: 1.2em; font-weight: 700; color: #fb641b; }
        .main-footer { text-align: center; padding: 20px; background-color: #1c1c1c; color: white; margin-top: 40px; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content container">
            <div class="logo">
                <a href="index.html" style="display: flex; align-items: center;">
                    <span style="font-size: 1.8em; font-weight: 700; color: #0048E3;">All In One Store</span>
                </a>
            </div>
            <nav class="header-nav">
                <a href="cart.html">üõí **Return to Cart**</a> 
            </nav>
        </div>
    </header>

    <main class="container checkout-main">
        <h1>üí≥ Secure Checkout</h1>

        <div class="checkout-layout">
            
            <div class="checkout-form-section">
                
                <div id="address-section"> 
                    <h2>1. Delivery Address</h2>
                    <form id="shipping-form" class="checkout-form">
                        <input type="text" placeholder="Full Name" required>
                        <input type="text" placeholder="Mobile Number" required>
                        <input type="text" placeholder="Address Line 1 (House No., Street)" required>
                        <input type="text" placeholder="Pincode" required>
                        <button type="submit" class="save-address-btn">Save Address & Continue</button>
                    </form>
                </div>
                
                <div id="payment-section" style="display: none;"> 
                    <h2>2. Payment Method</h2>
                    <div class="payment-options">
                        
                        <label class="payment-option-card">
                            <input type="radio" name="payment-method" value="qr" id="payment-qr">
                            <span>Scan UPI QR Code / UPI ID</span>
                            <p>Pay using any UPI app like Paytm, GPay, or PhonePe.</p>
                        </label>

                        <div id="qr-display-area" style="display: none; text-align: center; padding: 15px; background-color: #f7f7f7; border-radius: 8px; margin-top: 10px;">
                            <h3>Scan to Pay</h3>
                            <img id="" src="AQ.jpg" alt="Scan UPI QR Code" style="width: 150px; height: 150px; border: 1px solid #ddd; margin: 10px 0;">
                            <p style="font-size: 0.9em; color: #555;">Or use UPI ID: <strong id="upi-display-id"></strong></p>
                            <p style="color: #FF5722; font-weight: 600;">Amount: ‚Çπ <span id="qr-amount-display">0</span></p>
                        </div>
                        
                        <label class="payment-option-card">
                            <input type="radio" name="payment-method" value="cod" checked>
                            <span>Cash On Delivery (COD)</span>
                            <p>Pay with cash when you receive the order.</p>
                        </label>
                        
                    </div>
                    
                    <button id="place-order-btn" class="checkout-btn" disabled style="opacity: 0.7;">
                        Place Order (‚Çπ <span id="final-total-display">0</span>)
                    </button>
                </div>

            </div>

            <div class="cart-summary checkout-summary">
                <h2 class="summary-heading">üì¶ Order Summary (<span id="summary-total-qty">0</span> Items)</h2>
                
                <div id="checkout-items-list">
                </div>

                <div class="summary-details">
                    <p>Subtotal: <span id="summary-total-price">‚Çπ 0</span></p>
                    <p>Discount: <span id="summary-discount">- ‚Çπ 0</span></p>
                    <p>Delivery Charges: <span id="summary-delivery">‚Çπ 40</span></p>
                </div>
                
                <div class="summary-total">
                    <p>Total Payable: <span id="summary-final-total">‚Çπ 0</span></p>
                </div>
            </div>

        </div>
    </main>

    <footer class="main-footer">
        <p>&copy; 2025 All In One Store. All rights reserved.</p>
    </footer>
    
    <div id="customToast"></div> 

    <script>
        window.productDatabase = {
            '1': { 
                title: 'Smartwatch Model X', price: 9999, oldPrice: '‚Çπ 19,999', image: 'https://www.titan.co.in/dw/image/v2/BKDD_PRD/on/demandware.static/-/Sites-titan-master-catalog/default/dwf5666e88/images/Fastrack/Catalog/38148QM01_1.jpg?sw=360&sh=360', 
                priceDisplay: '‚Çπ 9,999', oldPrice: '‚Çπ 19,999' 
            },
            '2': { 
                title: "Man's T-shirt", price: 399, oldPrice: '‚Çπ 1,299', image: 'https://img.freepik.com/premium-photo/black-plain-shortsleeve-cotton-t-shirt-template-isolated-white-background_41929-3076.jpg', 
                priceDisplay: '‚Çπ 399', oldPrice: '‚Çπ 1,299' 
            },
            '3': { 
                title: 'Premium Headphones', price: 1499, oldPrice: '‚Çπ 2,499', image: 'https://www.leafstudios.in/cdn/shop/files/1_a43c5e0b-3a47-497d-acec-b4764259b10e_1024x1024.png?v=1750486829', 
                priceDisplay: '‚Çπ 1,499', oldPrice: '‚Çπ 2,499' 
            },
            '4': { 
                title: 'PowerBank', price: 1250, oldPrice: '‚Çπ 1,800', image: 'https://zebronics.com/cdn/shop/files/Zeb-MB10000S9-Pro-pic1.jpg?v=1755673820&width=800', 
                priceDisplay: '‚Çπ 1,250', oldPrice: '‚Çπ 1,800' 
            },
            '5': { 
                title: 'HP Victus Laptop', price: 49999, oldPrice: '‚Çπ 62,500', image: 'https://media-ik.croma.com/prod/https://media.tatacroma.com/Croma%20Assets/Computers%20Peripherals/Laptop/Images/309065_0_xb9gpu.png?tr=w-640', 
                priceDisplay: '‚Çπ 49,999', oldPrice: '‚Çπ 62,500' 
            }
            // ‡§Ö‡§®‡•ç‡§Ø ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç...
        };
    </script>
    
    <script>
        // ====================================
        // CONFIGURATION
        // ====================================
        const UPI_ID = 'adarsh153@ybl'; 
        const MERCHANT_NAME = 'AllInOneStore'; 
        const DELIVERY_THRESHOLD = 500;
        const DELIVERY_CHARGE = 40;
        let finalOrderTotal = 0; 
        
        // Helper function to parse price string 
        function parsePrice(priceStr) {
            if (!priceStr) return 0;
            // .replace(/[^\d.]/g, '') ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§ï‡•á‡§µ‡§≤ numbers ‡§ï‡•ã ‡§∞‡§ñ‡•á‡§Ç
            const cleanedStr = priceStr.replace(/[^0-9]/g, ''); 
            return parseInt(cleanedStr) || 0;
        }

        // ----------------------------------------------------
        // Dynamic QR Code Generation Logic
        // ----------------------------------------------------
        function updateQrCode() {
            const qrAmountDisplay = document.getElementById('qr-amount-display');
            const qrCodeImg = document.getElementById('qr-code-img'); 
            const upiIdDisplay = document.getElementById('upi-display-id');
            
            if (finalOrderTotal <= 0) return;

            const formattedAmount = finalOrderTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            qrAmountDisplay.textContent = formattedAmount;
            if (upiIdDisplay) upiIdDisplay.textContent = UPI_ID;
            
            const encodedAmount = finalOrderTotal.toFixed(2);
            
            const upiUrl = `upi://pay?pa=${UPI_ID}&pn=${MERCHANT_NAME}&am=${encodedAmount}&cu=INR`;
            // Google Charts API ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á QR ‡§ï‡•ã‡§° ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞‡§®‡§æ
            const qrCodeUrl = `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(upiUrl)}`;

            if (qrCodeImg) {
                qrCodeImg.src = qrCodeUrl;
            }
        }


        // ----------------------------------------------------
        // Main function to Render the Order Summary
        // ----------------------------------------------------
        function renderCheckoutSummary() {
            // üí• FIX 2: Local Storage keys ‡§ï‡•ã ‡§†‡•Ä‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
            let buyNowItem = JSON.parse(localStorage.getItem('buyNowItem')); 
            let cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // Priority: 1. Buy Now Item (product.html ‡§∏‡•á) 2. Cart Items (cart.html ‡§∏‡•á)
            let itemsToDisplay = [];
            if (buyNowItem && buyNowItem.length > 0) {
                 itemsToDisplay = buyNowItem;
            } else if (cartItems.length > 0) {
                 itemsToDisplay = cartItems;
            }

            const itemsList = document.getElementById('checkout-items-list');
            
            if (itemsToDisplay.length === 0) {
                // ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§¶‡§ø ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§§‡•ã ‡§∞‡•Ä‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§π‡•ã
                showToast("Your cart is empty. Redirecting to home.");
                setTimeout(() => {
                    window.location.href = 'index.html'; 
                }, 1500);
                return;
            }

            let subTotal = 0;
            let totalOriginalPrice = 0;
            let totalQuantity = 0;

            itemsList.innerHTML = '';

            itemsToDisplay.forEach(item => {
                // productDatabase ‡§Ö‡§¨ window.productDatabase ‡§∏‡•á ‡§Ü‡§§‡§æ ‡§π‡•à
                const productDetails = window.productDatabase ? window.productDatabase[item.id] : null; 
                if (!productDetails) return; 
                
                // priceDisplay ‡§∏‡•á price ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡§æ
                const currentPrice = productDetails.price; 
                const originalPrice = parsePrice(productDetails.oldPrice);
                
                subTotal += currentPrice * item.quantity;
                totalOriginalPrice += originalPrice * item.quantity;
                totalQuantity += item.quantity;

                itemsList.innerHTML += `
                    <div class="summary-item">
                        <img src="${productDetails.image}" alt="${productDetails.title}" style="width: 50px; height: 50px; object-fit: contain;">
                        <p>${productDetails.title} <span>x ${item.quantity}</span></p>
                        <p style="font-weight: 600;">‚Çπ ${(currentPrice * item.quantity).toLocaleString('en-IN')}</p>
                    </div>
                `;
            });

            const deliveryCharge = subTotal >= DELIVERY_THRESHOLD ? 0 : DELIVERY_CHARGE;
            finalOrderTotal = subTotal + deliveryCharge;
            const savings = Math.max(0, totalOriginalPrice - subTotal);

            document.getElementById('summary-total-qty').textContent = totalQuantity;
            document.getElementById('summary-total-price').textContent = `‚Çπ ${subTotal.toLocaleString('en-IN')}`;
            document.getElementById('summary-discount').textContent = `- ‚Çπ ${savings.toLocaleString('en-IN')}`;
            
            const deliverySpan = document.getElementById('summary-delivery');
            if (deliveryCharge === 0) {
                deliverySpan.textContent = 'FREE';
                deliverySpan.style.color = 'green';
            } else {
                deliverySpan.textContent = `‚Çπ ${deliveryCharge}`;
                deliverySpan.style.color = '';
            }
            
            document.getElementById('summary-final-total').textContent = `‚Çπ ${finalOrderTotal.toLocaleString('en-IN')}`;
            
            const finalTotalDisplay = document.getElementById('final-total-display');
            if (finalTotalDisplay) {
                finalTotalDisplay.textContent = finalOrderTotal.toLocaleString('en-IN');
            }
            
            updateQrCode();
        }

        document.addEventListener('DOMContentLoaded', function() {
            renderCheckoutSummary(); 
            
            const shippingForm = document.getElementById('shipping-form');
            const placeOrderBtn = document.getElementById('place-order-btn');
            const addressSection = document.getElementById('address-section');
            const paymentSection = document.getElementById('payment-section');
            const paymentOptions = document.querySelectorAll('input[name="payment-method"]');
            const qrDisplayArea = document.getElementById('qr-display-area');

            // --- 2. Address Submission Logic ---
            if (shippingForm) {
                shippingForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // ‡§è‡§°‡•ç‡§∞‡•á‡§∏ ‡§ï‡•ã ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à

                    addressSection.style.display = 'none';
                    paymentSection.style.display = 'block'; 

                    showToast("‚úÖ Address Saved! Now select Payment Method."); 
                    placeOrderBtn.disabled = false; 
                    placeOrderBtn.style.opacity = 1;
                });
            }

            // --- 3. Payment Method Change Logic ---
            paymentOptions.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'qr') {
                        qrDisplayArea.style.display = 'block';
                        updateQrCode(); 
                    } else {
                        qrDisplayArea.style.display = 'none';
                    }
                });
            });

            // --- 4. Place Order Logic ---
            if (placeOrderBtn) {
                placeOrderBtn.addEventListener('click', function() {
                    showToast(`üéâ Order Placed Successfully! Total: ‚Çπ ${finalOrderTotal.toLocaleString('en-IN')}`);
                    
                    // üí• FIX 3: ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú keys ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç 
                    localStorage.removeItem('cart'); 
                    localStorage.removeItem('buyNowItem'); 
                    
                    setTimeout(() => {
                        window.location.href = 'index.html'; 
                    }, 1000); 
                });
            }
        });
    </script>
    <script src="security.js"></script>
</body>
</html>
